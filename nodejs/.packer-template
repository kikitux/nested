{
  "builders": [
    {
      "type": "docker",
      "name": "trusty",
      "image": "ubuntu:14.04.3",
      "discard": true
    },
    {
      "type": "docker",
      "name": "ol7",
      "image": "oraclelinux:7.1",
      "discard": true
    }
  ],
  "provisioners": [
    {
      "only": ["ol7"],
      "type": "shell",
      "inline": [
        "export http_proxy=http://mini.home.kikitux.net:3128",
        "export https_proxy=http://mini.home.kikitux.net:3128",
        "yum install -y yum-utils",
        "yum-config-manager --enable ol7_addons",
        "yum-config-manager --enable ol7_latest",
        "yum-config-manager --enable ol7_optional_latest",
        "yum-config-manager --enable ol7_UEKR3",
        "yum install -y curl tar gzip gcc-c++ gcc which make",
        "curl -sL https://rpm.nodesource.com/setup | bash -",
        "yum install -y nodejs npm"
      ]
    },
    {
      "only": ["trusty"],
      "type": "shell",
      "inline": [
        "export http_proxy=http://mini.home.kikitux.net:3128",
        "export https_proxy=http://mini.home.kikitux.net:3128",
        "apt-get -y update",
        "apt-get -y install curl tar gzip gcc g++ make",
        "curl -sL https://deb.nodesource.com/setup_0.12 | sudo -E bash -",
        "apt-get install -y nodejs"

      ]
    },
    {
      "type": "shell",
      "inline": [
        "mkdir -p /usr/local/nested/"
      ]
    },
    {
      "type": "file",
      "source": "./",
      "destination": "/usr/local/nested/"
    },
    {
      "type": "shell",
      "inline": [
        "cd /usr/local/nested/",
        "npm install .", 
        "tar zcvf /nested.tar.gz ."
      ]
    },
    {
      "only": ["ol7"],
      "type": "file",
      "source": "/nested.tar.gz",
      "destination": "nested-ol7.tar.gz",
      "direction": "download"
    },
    {
      "only": ["trusty"],
      "type": "file",
      "source": "/nested.tar.gz",
      "destination": "nested-trusty.tar.gz",
      "direction": "download"
    }
  ],
  "post-processors": [
    [
      {
        "type": "artifice",
        "files": ["nested-{{.Provider}}.tar.gz"]
      },
      {
        "only": ["ol7"],
        "type":"atlas",
        "artifact": "alvaro/nested-ol7",
        "artifact_type": "archive"
      },
      {
        "only": ["trusty"],
        "type":"atlas",
        "artifact": "alvaro/nested-trusty",
        "artifact_type": "archive"
      }
    ]
  ]
}
